import { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell } from 'recharts';
import { Users, TrendingUp, TrendingDown, PhilippinePeso, ShoppingCart, Settings, Target, RefreshCw  } from 'lucide-react';
import { studentService, transactionService } from '@/lib/services';
import { format, subDays, startOfDay, endOfDay, getHours } from 'date-fns';
import { toast } from 'sonner';
import { DottedSeparator } from '../ui/dotted-line';

const COLORS = ['#14a800', '#0ea5e9', '#f59e0b', '#ef4444', '#8b5cf6'];

export function AdminDashboard() {
  const [loading, setLoading] = useState(true);
  const [monthlyTarget, setMonthlyTarget] = useState(() => {
    
    const saved = localStorage.getItem('monthlyTarget');
    return saved ? parseFloat(saved) : 50000; 
  });
  const [showTargetDialog, setShowTargetDialog] = useState(false);
  const [newTarget, setNewTarget] = useState('');
  const [isMaintenance, setIsMaintenance] = useState(false);
  const [stats, setStats] = useState({
    totalStudents: 0,
    activeStudentsToday: 0,
    dailyRevenue: 0,
    yesterdayRevenue: 0,
    weeklyRevenue: 0,
    lastWeekRevenue: 0,
    monthlyRevenue: 0,
    totalTransactions: 0,
    dailyTransactions: 0,
    yesterdayTransactions: 0,
    averageTransaction: 0
  });
  const [revenueData, setRevenueData] = useState<any[]>([]);
  const [courseData, setCourseData] = useState<any[]>([]);
  const [peakHoursData, setPeakHoursData] = useState<any[]>([]);
  const [recentSales, setRecentSales] = useState<any[]>([]);

  const handleSetMonthlyTarget = () => {
    const target = parseFloat(newTarget);
    if (isNaN(target) || target < 0) {
      toast.error('Please enter a valid target amount');
      return;
    }
    setMonthlyTarget(target);
    
    localStorage.setItem('monthlyTarget', target.toString());
    setShowTargetDialog(false);
    setNewTarget('');
    toast.success(`Monthly target set to â‚±${target.toFixed(2)}`);
  };

  const loadDashboardData = async () => {
      try {
        setLoading(true);
        
        // Check maintenance mode
        try {
          const { settingsService } = await import('@/lib/services');
          const maintenanceStatus = await settingsService.isSystemInMaintenance();
          setIsMaintenance(maintenanceStatus);
        } catch (error) {
          console.error('Error checking maintenance status:', error);
        }
        
        // Load admins/cashiers
        const [studentsResponse, transactionsResponse] = await Promise.all([
          studentService.getStudents(),
          transactionService.getTransactions()
        ]);

        const students = studentsResponse.documents;
        const transactions = transactionsResponse.documents;
        // const products = productsResponse.documents;

        
        const studentsMap = new Map();
        students.forEach((student: any) => {
          studentsMap.set(student.studentId, student);
        });

        
        const transformedTransactions = transactions.map((txn: any) => {
          const student = studentsMap.get(txn.studentId);
          
          
          let timestamp: Date;
          try {
            // Appwrite stores timestamps in ISO format, parse directly
            timestamp = new Date(txn.$createdAt || txn.createdAt);
            if (isNaN(timestamp.getTime())) {
              console.warn('Invalid timestamp for transaction:', txn.$id, txn.$createdAt);
              timestamp = new Date(); 
            }
          } catch (error) {
            console.warn('Error parsing timestamp for transaction:', txn.$id, error);
            timestamp = new Date(); 
          }
          
          return {
            id: txn.$id,
            studentId: txn.studentId,
            studentName: student ? `${student.firstName} ${student.lastName}` : 'Unknown Student',
            course: student ? student.course : 'Unknown',
            amount: txn.amount,
            transactionAmount: txn.transactionAmount,
            itemPrices: txn.itemPrices,
            totalItemAmount: txn.totalItemAmount,
            timestamp: timestamp,
            cashier: txn.cashierId || 'Admin',
            status: txn.status || 'completed',
          };
        });

        
        const totalStudents = students.length;
        const totalTransactions = transformedTransactions.length;
        const totalRevenue = transformedTransactions
          .filter((txn: any) => txn.status !== 'Credit')
          .reduce((sum: number, txn: any) => sum + (txn.totalItemAmount || 0), 0);
        const averageTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;

        
        const today = new Date();
        const todayStart = startOfDay(today);
        const todayEnd = endOfDay(today);
        const dailyRevenue = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= todayStart && txn.timestamp <= todayEnd && txn.status !== 'Credit';
          })
          .reduce((sum: number, txn: any) => {
            // For revenue, use the actual money received (transactionAmount)
            // For paid transactions, use totalItemAmount
            // For partial transactions, use transactionAmount (actual money received)
            if (txn.status === 'Partial') {
              return sum + (txn.transactionAmount || 0);
            } else {
              return sum + (txn.totalItemAmount || 0);
            }
          }, 0);

        
        const dailyTransactions = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= todayStart && txn.timestamp <= todayEnd && txn.status !== 'Credit';
          }).length;

        
        const yesterday = subDays(today, 1);
        const yesterdayStart = startOfDay(yesterday);
        const yesterdayEnd = endOfDay(yesterday);
        const yesterdayRevenue = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= yesterdayStart && txn.timestamp <= yesterdayEnd && txn.status !== 'Credit';
          })
          .reduce((sum: number, txn: any) => {
            // For revenue, use the actual money received (transactionAmount)
            if (txn.status === 'Partial') {
              return sum + (txn.transactionAmount || 0);
            } else {
              return sum + (txn.totalItemAmount || 0);
            }
          }, 0);

        
        const yesterdayTransactions = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= yesterdayStart && txn.timestamp <= yesterdayEnd && txn.status !== 'Credit';
          }).length;

        
        const weekAgo = subDays(today, 7);
        const weeklyRevenue = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= weekAgo && txn.status !== 'Credit';
          })
          .reduce((sum: number, txn: any) => {
            // For revenue, use the actual money received (transactionAmount)
            if (txn.status === 'Partial') {
              return sum + (txn.transactionAmount || 0);
            } else {
              return sum + (txn.totalItemAmount || 0);
            }
          }, 0);

        
        const lastWeekStart = subDays(today, 14);
        const lastWeekEnd = subDays(today, 8);
        const lastWeekRevenue = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= lastWeekStart && txn.timestamp <= lastWeekEnd && txn.status !== 'Credit';
          })
          .reduce((sum: number, txn: any) => {
            // For revenue, use the actual money received (transactionAmount)
            if (txn.status === 'Partial') {
              return sum + (txn.transactionAmount || 0);
            } else {
              return sum + (txn.totalItemAmount || 0);
            }
          }, 0);

        
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthlyRevenue = transformedTransactions
          .filter((txn: any) => {
            if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
            return txn.timestamp >= monthStart && txn.status !== 'Credit';
          })
          .reduce((sum: number, txn: any) => {
            // For revenue, use the actual money received (transactionAmount)
            if (txn.status === 'Partial') {
              return sum + (txn.transactionAmount || 0);
            } else {
              return sum + (txn.totalItemAmount || 0);
            }
          }, 0);

        
        // Active students count - using same logic as StudentsPage
        const activeStudents = students.filter((student: any) => {
          if (!student.isActive) {
            return false; // Suspended students are not active
          }
          
          // Check if student has made at least 3 transactions in the past 3 days
          const threeDaysAgo = new Date();
          threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
          
          const studentTransactions = transformedTransactions.filter((txn: any) => 
            txn.studentId === student.studentId
          );
          
          const recentTransactions = studentTransactions.filter((txn: any) => {
            try {
              return txn.timestamp && !isNaN(txn.timestamp.getTime()) && txn.timestamp >= threeDaysAgo;
            } catch (error) {
              return false;
            }
          });
          
          return recentTransactions.length >= 3;
        }).length;

        setStats({
          totalStudents,
          activeStudentsToday: activeStudents,
          dailyRevenue,
          yesterdayRevenue,
          weeklyRevenue,
          lastWeekRevenue,
          monthlyRevenue,
          totalTransactions,
          dailyTransactions,
          yesterdayTransactions,
          averageTransaction
        });

        
        const revenueData = [];
        for (let i = 6; i >= 0; i--) {
          const date = subDays(today, i);
          const dayStart = startOfDay(date);
          const dayEnd = endOfDay(date);
          
          const dayRevenue = transformedTransactions
            .filter((txn: any) => {
              if (!txn.timestamp || isNaN(txn.timestamp.getTime())) return false;
              return txn.timestamp >= dayStart && txn.timestamp <= dayEnd && txn.status !== 'Credit';
            })
            .reduce((sum: number, txn: any) => {
              // For revenue, use the actual money received (transactionAmount)
              if (txn.status === 'Partial') {
                return sum + (txn.transactionAmount || 0);
              } else {
                return sum + (txn.totalItemAmount || 0);
              }
            }, 0);

          revenueData.push({
            name: format(date, 'EEE'),
            revenue: parseFloat(dayRevenue.toFixed(2))
          });
        }
        setRevenueData(revenueData);

        
        const courseMap = new Map<string, number>();
        transformedTransactions.forEach((txn: any) => {
          const course = txn.course;
          courseMap.set(course, (courseMap.get(course) || 0) + 1);
        });

        const courseData = Array.from(courseMap.entries())
          .map(([course, count]) => ({
            name: course,
            purchases: count,
            percentage: Math.round((count / totalTransactions) * 100)
          }))
          .sort((a, b) => b.purchases - a.purchases)
          .slice(0, 5);

        setCourseData(courseData);

        
        const hourMap = new Map<number, number>();
        for (let i = 0; i < 24; i++) {
          hourMap.set(i, 0);
        }

        transformedTransactions.forEach((txn: any) => {
          if (txn.timestamp && !isNaN(txn.timestamp.getTime())) {
            const hour = getHours(txn.timestamp);
            hourMap.set(hour, (hourMap.get(hour) || 0) + 1);
          }
        });

        const peakHoursData = Array.from(hourMap.entries())
          .map(([hour, count]) => ({
            time: `${hour === 0 ? 12 : hour > 12 ? hour - 12 : hour}${hour >= 12 ? 'PM' : 'AM'}`,
            transactions: count
          }))
          .sort((a, b) => {
            const hourA = parseInt(a.time.replace(/\D/g, ''));
            const hourB = parseInt(b.time.replace(/\D/g, ''));
            return hourA - hourB;
          });

        setPeakHoursData(peakHoursData);

        
        // Sort transactions by timestamp (newest first), then by ID as fallback
        const sortedTransactions = transformedTransactions.sort((a, b) => {
          const timeDiff = b.timestamp.getTime() - a.timestamp.getTime();
          if (timeDiff !== 0) return timeDiff;
          // If timestamps are the same, sort by ID (newer IDs come first)
          return b.id.localeCompare(a.id);
        });
        
        const recentSales = sortedTransactions
          .slice(0, 4)
          .map((txn: any) => ({
            id: txn.id,
            studentId: txn.studentId,
            name: txn.studentName,
            amount: txn.amount,
            time: format(txn.timestamp, 'MMM dd, HH:mm'),
            course: txn.course.substring(0, 3).toUpperCase()
          }));

        setRecentSales(recentSales);

      } catch (error) {
        console.error('Error loading dashboard data:', error);
      } finally {
        setLoading(false);
      }
    };

  useEffect(() => {
    loadDashboardData();
  }, []);

  // Refresh dashboard when window regains focus (e.g., when returning from transaction page)
  useEffect(() => {
    const handleFocus = () => {
      loadDashboardData();
    };

    window.addEventListener('focus', handleFocus);
    return () => window.removeEventListener('focus', handleFocus);
  }, []);

  // Listen for new transaction events and refresh dashboard
  useEffect(() => {
    const handleTransactionCreated = () => {
      console.log('TransactionCreated event received, refreshing dashboard...');
      loadDashboardData();
    };

    window.addEventListener('transactionCreated', handleTransactionCreated);
    return () => window.removeEventListener('transactionCreated', handleTransactionCreated);
  }, []);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
          <p className="mt-2 text-muted-foreground">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Dashboard Header with Refresh Button */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-xl md:text-2xl font-bold">Admin Dashboard</h1>
          <p className="text-sm text-muted-foreground">Overview of your student information system</p>
        </div>
        <Button 
          variant="outline" 
          onClick={() => loadDashboardData()}
          disabled={loading}
          className="flex items-center gap-2"
        >
          <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
          <span className="hidden sm:inline">Refresh</span>
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Students</CardTitle>
            <Users className="h-5 w-5 text-blue-500" />
          </CardHeader>
          <CardContent>
            <div className="text-xl md:text-2xl font-bold">{stats.totalStudents}</div>
            <DottedSeparator className="my-2" />
            <div className="flex items-center justify-between text-xs text-muted-foreground mb-2">
              <span>{stats.activeStudentsToday} active</span>
              <span>{stats.totalStudents > 0 ? Math.round((stats.activeStudentsToday / stats.totalStudents) * 100) : 0}%</span>
            </div>
            <Progress 
              value={stats.totalStudents > 0 ? (stats.activeStudentsToday / stats.totalStudents) * 100 : 0} 
              className="h-2"
            />
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Today's Revenue</CardTitle>
            <PhilippinePeso className="h-5 w-5 text-green-500" />
          </CardHeader>
          <CardContent>
            <div className="text-xl md:text-2xl font-bold">â‚±{stats.dailyRevenue.toFixed(2)}</div>
            <DottedSeparator className="my-2" />
            <div className="space-y-1">
              <div className={`flex items-center gap-1 text-xs md:text-sm ${
                stats.dailyRevenue >= stats.yesterdayRevenue ? 'text-green-600' : 'text-red-600'
              }`}>
                {stats.dailyRevenue >= stats.yesterdayRevenue ? (
                  <TrendingUp className="h-4 w-4" />
                ) : (
                  <TrendingDown className="h-4 w-4" />
                )}
                <span className="truncate">
                  {stats.yesterdayRevenue > 0 ? 
                    `${Math.abs(((stats.dailyRevenue - stats.yesterdayRevenue) / stats.yesterdayRevenue) * 100).toFixed(0)}% from yesterday` :
                    '0% from yesterday'
                  }
                </span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">This Week</CardTitle>
            <Target className="h-5 w-5 text-muted-foreground text-violet-500" />
          </CardHeader>
          <CardContent>
            <div className="text-xl md:text-2xl font-bold">â‚±{stats.weeklyRevenue.toFixed(2)}</div>
            <DottedSeparator className="my-2" />
            <div className={`flex items-center gap-1 text-xs md:text-sm ${
              stats.weeklyRevenue >= stats.lastWeekRevenue ? 'text-green-600' : 'text-red-600'
            }`}>
              {stats.weeklyRevenue >= stats.lastWeekRevenue ? (
                <TrendingUp className="h-4 w-4" />
              ) : (
                <TrendingDown className="h-4 w-4" />
              )}
              <span className="truncate">
                {stats.lastWeekRevenue > 0 ? 
                  `${Math.abs(((stats.weeklyRevenue - stats.lastWeekRevenue) / stats.lastWeekRevenue) * 100).toFixed(0)}% from last week` :
                  '0% from last week'
                }
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Transactions</CardTitle>
            <ShoppingCart className="h-5 w-5 text-muted-foreground text-orange-500" />
          </CardHeader>
          <CardContent>
            <div className="text-xl md:text-2xl font-bold">{stats.totalTransactions}</div>
            <DottedSeparator className="my-2" />
            <div className={`flex items-center gap-1 text-xs md:text-sm ${
              stats.dailyTransactions >= stats.yesterdayTransactions ? 'text-green-600' : 'text-red-600'
            }`}>
              {stats.dailyTransactions >= stats.yesterdayTransactions ? (
                <TrendingUp className="h-4 w-4" />
              ) : (
                <TrendingDown className="h-4 w-4" />
              )}
              <span className="truncate">
                {stats.yesterdayTransactions > 0 ? 
                  `${Math.abs(((stats.dailyTransactions - stats.yesterdayTransactions) / stats.yesterdayTransactions) * 100).toFixed(0)}% from yesterday` :
                  '0% from yesterday'
                }
              </span>
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        {/* Revenue Trend */}
        <Card>
          <CardHeader className='bg-primary rounded-t-lg mb-2 p-4'>
            <CardTitle className='font-bold text-white text-base'>Revenue Trend</CardTitle>
            <CardDescription className='text-white text-xs'>Daily revenue for the past week</CardDescription>
          </CardHeader>
          <CardContent className="p-2">
            <ResponsiveContainer width="100%" height={250} className='text-xs'>
              <LineChart data={revenueData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip formatter={(value) => [`â‚±${value}`, 'Revenue']} />
                <Line type="monotone" dataKey="revenue" stroke="#14a800" strokeWidth={2} />
              </LineChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Transactions by Course */}
        <Card>
          <CardHeader className='bg-primary rounded-t-lg mb-2 p-4'>
            <CardTitle className='font-bold text-white text-base'>Transactions by Course</CardTitle>
            <CardDescription className='text-white text-xs'>Breakdown of transactions by student course</CardDescription>
          </CardHeader>
          <CardContent className="p-2">
            <div className="flex flex-col md:flex-row items-center justify-center gap-4">
              <div className="relative w-48 h-48">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={courseData}
                      cx="50%"
                      cy="50%"
                      innerRadius={40}
                      outerRadius={80}
                      paddingAngle={5}
                      dataKey="purchases"
                    >
                      {courseData.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip formatter={(value) => [value, 'Transactions']} />
                  </PieChart>
                </ResponsiveContainer>
                
                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-foreground">
                      {stats.totalTransactions}
                    </div>
                    <div className="text-xs text-muted-foreground">
                      Total
                    </div>
                  </div>
                </div>
              </div>
              <div className="mt-4 md:mt-0 space-y-2 w-full md:w-auto">
                {courseData.map((entry, index) => (
                  <div key={entry.name} className="flex items-center justify-between text-xs">
                    <div className="flex items-center gap-2">
                      <div 
                        className="w-2.5 h-2.5 rounded-full" 
                        style={{ backgroundColor: COLORS[index % COLORS.length] }}
                      />
                      <span className="font-medium">{entry.name}</span>
                    </div>
                    <span className="text-muted-foreground">
                      {entry.purchases} ({entry.percentage}%)
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Additional Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        {/* Peak Hours */}
        <Card className="py-0">
          <CardHeader className="flex flex-col border-b items-stretch !p-0 sm:flex-row">
            <div className="flex flex-1 flex-col justify-center gap-1 px-4 py-3 sm:!py-0">
              <CardTitle className="text-base">Peak Transaction Hours</CardTitle>
              <CardDescription className="text-xs">Transaction volume throughout the day</CardDescription>
            </div>
            <div className="flex">
              <div className="relative z-30 flex flex-1 flex-col justify-center gap-1 border-t px-4 py-3 text-left sm:border-t-0 sm:px-6 sm:py-4 bg-muted/50">
                <span className="text-muted-foreground text-xs">Peak Hour</span>
                <span className="text-lg leading-none font-bold sm:text-2xl text-primary">
                {peakHoursData.length > 0 ? 
                  peakHoursData.find(item => item.transactions === Math.max(...peakHoursData.map(h => h.transactions)))?.time || '' 
                  : ''
                }
                </span>
              </div>
            </div>
          </CardHeader>
          <CardContent className="px-2 sm:p-4">
            <ResponsiveContainer width="100%" height={220}>
              <BarChart
                data={peakHoursData}
                margin={{
                  left: 0,
                  right: 12,
                }}
              >
                <CartesianGrid vertical={false} strokeDasharray="3 3" />
                <XAxis
                  dataKey="time"
                  tickLine={false}
                  axisLine={false}
                  tickMargin={8}
                  minTickGap={32}
                  tick={{ fontSize: 10 }}
                />
                <YAxis
                  tickLine={false}
                  axisLine={false}
                  tickMargin={8}
                  tick={{ fontSize: 10 }}
                />
                <Tooltip 
                  formatter={(value) => [value, 'Transactions']}
                  contentStyle={{
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                  }}
                />
                <Bar 
                  dataKey="transactions" 
                  fill="#14a800"
                  radius={[4, 4, 0, 0]}
                  className="hover:opacity-80 transition-opacity"
                />
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        {/* Recent Sales */}
        <Card className="py-0">
          <CardHeader className="flex flex-col border-b items-stretch !p-0 sm:flex-row">
            <div className="flex flex-1 flex-col justify-center gap-1 px-4 py-3 sm:!py-0">
              <CardTitle className="text-base">Recent Sales</CardTitle>
              <CardDescription className="text-xs">Latest transactions</CardDescription>
            </div>
            <div className="flex">
              <div className="relative z-30 flex flex-1 flex-col justify-center gap-1 border-t px-4 py-3 text-left sm:border-t-0 sm:px-6 sm:py-4 bg-muted/50">
                <span className="text-muted-foreground text-xs">Today's Sales</span>
                <span className="text-lg leading-none font-bold sm:text-2xl text-primary">
                  {stats.dailyTransactions}
                </span>
              </div>
            </div>
          </CardHeader>
          <CardContent className="px-2 sm:p-4">
            <div className="space-y-3">
              {recentSales.map((sale) => (
                <div key={sale.id} className="flex items-center justify-between p-2 border rounded-lg">
                  <div className="flex items-center space-x-2">
                    <div className="p-1.5 bg-primary/10 rounded-full">
                      <ShoppingCart className="h-3.5 w-3.5 text-primary" />
                    </div>
                    <div>
                      <p className="font-medium text-sm">{sale.name}</p>
                      <p className="text-xs text-muted-foreground">
                        {sale.studentId} â€¢ {sale.course}
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="font-semibold text-sm">â‚±{sale.amount.toFixed(2)}</p>
                    <p className="text-xs text-muted-foreground">{sale.time}</p>
                  </div>
                </div>
              ))}
              
              {recentSales.length === 0 && (
                <div className="text-center py-6">
                  <ShoppingCart className="h-10 w-10 text-muted-foreground mx-auto mb-3" />
                  <p className="text-sm text-muted-foreground">No recent transactions</p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader className="p-4">
            <CardTitle className="text-sm">Average Transaction</CardTitle>
          </CardHeader>
          <CardContent className="p-4 pt-0">
            <div className="text-xl md:text-2xl font-bold">â‚±{stats.averageTransaction.toFixed(2)}</div>
            <Progress value={Math.min((stats.averageTransaction / 200) * 100, 100)} className="mt-2 h-1.5" />
            <p className="text-xs text-muted-foreground mt-1">
              Per transaction average
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2 p-4">
            <CardTitle className="text-sm">This Month</CardTitle>
            <Dialog open={showTargetDialog} onOpenChange={setShowTargetDialog}>
              <DialogTrigger asChild>
                <Button variant="ghost" size="sm">
                  <Settings className="h-4 w-4" />
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Set Monthly Revenue Target</DialogTitle>
                  <DialogDescription>
                    Set the target revenue for the current month
                  </DialogDescription>
                </DialogHeader>
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="target">Monthly Target (â‚±)</Label>
                    <Input
                      id="target"
                      type="number"
                      placeholder="Enter target amount"
                      value={newTarget}
                      onChange={(e) => setNewTarget(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleSetMonthlyTarget()}
                    />
                  </div>
                  <div className="flex justify-end space-x-2">
                    <Button variant="outline" onClick={() => setShowTargetDialog(false)}>
                      Cancel
                    </Button>
                    <Button onClick={handleSetMonthlyTarget}>
                      Set Target
                    </Button>
                  </div>
                </div>
              </DialogContent>
            </Dialog>
          </CardHeader>
          <CardContent className="p-4 pt-0">
            <div className="text-xl md:text-2xl font-bold">â‚±{stats.monthlyRevenue.toFixed(2)}</div>
            <Progress value={Math.min((stats.monthlyRevenue / monthlyTarget) * 100, 100)} className="mt-2 h-1.5" />
            <p className="text-xs text-muted-foreground mt-1">
              Target: â‚±{monthlyTarget.toFixed(2)}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="p-4">
            <CardTitle className="text-sm">System Status</CardTitle>
          </CardHeader>
          <CardContent className="p-4 pt-0">
            <div className="flex items-center space-x-2">
              {isMaintenance ? (
                <div className="w-2.5 h-2.5 bg-red-500 rounded-full"></div>
              ) : (
                <div className="w-2.5 h-2.5 bg-green-500 rounded-full"></div>
              )}
              <span className="text-sm font-medium">
                {isMaintenance ? 'Maintenance Active' : 'Operational'}
              </span>
            </div>
            <p className="text-xs text-muted-foreground mt-1 truncate">
              {isMaintenance ? 'System is in maintenance mode.' : 'All systems running normally.'}
            </p>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}